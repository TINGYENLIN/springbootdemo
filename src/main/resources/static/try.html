<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>資料操作</title>
<style>
.hidden { display: none; }
.tab-btn {
  margin-right: 10px;
  padding: 6px 12px;
  cursor: pointer;
  background-color: #0078D4;
  color: white;
  border: none;
  border-radius: 4px;
}
table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 1em;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
}
th { background-color: #f0f0f0; }

.delete-btn {
  background-color: #d32f2f;
  color: white;
  border: none;
  border-radius: 3px;
  padding: 4px 8px;
  cursor: pointer;
}
.edit-btn {
  background-color: #1976d2;
  color: white;
  border: none;
  border-radius: 3px;
  padding: 4px 8px;
  margin-left: 4px;
  cursor: pointer;
}
.cancel-btn {
  background-color: #757575;
  color: white;
  border: none;
  border-radius: 3px;
  padding: 4px 8px;
  margin-left: 4px;
  cursor: pointer;
}
input { width: 100%; box-sizing: border-box; }
</style>
</head>

<body>
<h1>資料表操作</h1>

<button class="tab-btn" onclick="loadTable(apiemployee, container, 'employees')">送貨員列表</button>
<button class="tab-btn" onclick="loadTable(apimember, container, 'members')">會員清單</button>
<button class="tab-btn" onclick="loadTable(apiorders, container, 'orders')">歷史訂單查詢</button>
<button class="tab-btn" onclick="loadTable(apiproduct2, container, 'products')">產品列表</button>
<button class="tab-btn" onclick="loadTable(apilength, container, 'length')">長度</button>
<button class="tab-btn" onclick="loadTable(apiweight, container, 'weight')">寬度</button>

<div id="tableContainer">請點擊上方按鈕載入資料</div>

<script>
const apiemployee = 'http://localhost:8080/employees';
const apimember   = 'http://localhost:8080/members';
const apiorders   = 'http://localhost:8080/orders';
const apiproduct2 = 'http://localhost:8080/products';
const apilength   = 'http://localhost:8080/length';
const apiweight   = 'http://localhost:8080/weight';

const container = document.getElementById('tableContainer');

let currentData = [];
let currentTableName = '';

/* 載入表格 */
async function loadTable(url, target, tableName) {
  target.textContent = '載入中...';
  const res = await fetch(url);
  const data = await res.json();

  currentData = data;
  currentTableName = tableName;

  if (!data.length) {
    target.textContent = '沒有資料';
    return;
  }

  const keys = Object.keys(data[0]);
  let html = '<table><thead><tr><th>操作</th>';
  keys.forEach(k => html += `<th>${k}</th>`);
  html += '</tr></thead><tbody>';

  data.forEach((row, i) => {
    html += `<tr data-index="${i}"><td>
      <button class="delete-btn" onclick="deleteRow(${i})">刪除</button>`;

    // 只在這三張表顯示修改
    if (['orders','employees','members'].includes(tableName)) {
      html += `<button class="edit-btn" onclick="startEdit(${i})">修改</button>`;
    }

    html += `</td>`;

    keys.forEach(k => {
      html += `<td data-key="${k}">${row[k] ?? ''}</td>`;
    });

    html += '</tr>';
  });

  html += '</tbody></table>';
  target.innerHTML = html;
}

/* 刪除 */
function deleteRow(index) {
  if (!confirm('確定刪除？')) return;
  const row = currentData[index];

  fetch('http://localhost:8080/api/2/update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ...row, table: currentTableName, state: -1 })
  }).then(() => reloadCurrentTable());
}

/* 開始編輯 */
function startEdit(index) {
  const tr = container.querySelector(`tr[data-index="${index}"]`);
  const row = currentData[index];

  tr.querySelectorAll('td[data-key]').forEach(td => {
    const key = td.dataset.key;
    td.innerHTML = `<input value="${row[key] ?? ''}">`;
  });

  const btnCell = tr.firstChild;
  const editBtn = btnCell.querySelector('.edit-btn');

  editBtn.textContent = '確認修改';
  editBtn.onclick = () => confirmEdit(index);

  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = '取消';
  cancelBtn.className = 'cancel-btn';
  cancelBtn.onclick = () => cancelEdit(index);
  btnCell.appendChild(cancelBtn);
}

/* 取消編輯 */
function cancelEdit(index) {
  const tr = container.querySelector(`tr[data-index="${index}"]`);
  const row = currentData[index];

  tr.querySelectorAll('td[data-key]').forEach(td => {
    td.textContent = row[td.dataset.key] ?? '';
  });

  const btnCell = tr.firstChild;
  const editBtn = btnCell.querySelector('.edit-btn');
  editBtn.textContent = '修改';
  editBtn.onclick = () => startEdit(index);

  btnCell.querySelector('.cancel-btn')?.remove();
}

/* 確認修改 */
function confirmEdit(index) {
  const tr = container.querySelector(`tr[data-index="${index}"]`);
  const row = currentData[index];

  tr.querySelectorAll('input').forEach(input => {
    row[input.parentElement.dataset.key] = input.value.trim();
  });

  // 訂單才驗證
  if (currentTableName === 'orders') {
    if (!row.memberName || !row.productId) {
      return alert('會員姓名與產品編號必填');
    }
    if (row.memberPhone && !/^09\d{8}$/.test(row.memberPhone)) {
      return alert('手機格式錯誤');
    }
  }

  let api = '';
  let id = '';

  if (currentTableName === 'orders') {
    api = apiorders;
    id = row.idorders || row.orderId;
  } else if (currentTableName === 'employees') {
    api = apiemployee;
    id = row.id || row.employeeId;
  } else if (currentTableName === 'members') {
    api = apimember;
    id = row.id || row.memberId;
  }

  fetch(`${api}/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(row)
  }).then(() => reloadCurrentTable());
}

/* 重新載入 */
function reloadCurrentTable() {
  const map = {
    employees: apiemployee,
    members: apimember,
    orders: apiorders,
    products: apiproduct2,
    length: apilength,
    weight: apiweight
  };
  loadTable(map[currentTableName], container, currentTableName);
}
</script>
</body>
</html>
