<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>資料操作</title>
  <style>
    .hidden {
      display: none;
    } 
    .tab-btn {
      margin-right: 10px;
      padding: 6px 12px;
      cursor: pointer;
      background-color: #0078D4;
      color: white;
      border: none;
      border-radius: 4px;
    }  

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1em;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    #tableContainer {
      margin-bottom: 2em;
    }
    .delete-btn {
      padding: 4px 8px;
      background-color: #d32f2f;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .delete-btn:hover {
      background-color: #b71c1c;
    }
  </style>
</head>

<body>
  <div class="demoAPI06222">
    <h1>資料表操作</h1>
    <div>
      <button class="tab-btn" onclick="loadTable(apiemployee, container1, 'employees')">送貨員列表</button>
      <button class="tab-btn" onclick="loadTable(apimember, container1, 'members')">會員清單</button>
      <button class="tab-btn" onclick="loadTable(apiorders, container1, 'orders')">歷史訂單查詢</button>
      <button class="tab-btn" onclick="loadTable(apiproduct2, container1, 'products')">產品列表</button>
      <button class="tab-btn" onclick="loadTable(apilength, container1, 'length')">長度</button>
      <button class="tab-btn" onclick="loadTable(apiweight, container1, 'weight')">寬度</button>
      
      <div id="tableContainer">請點擊上方按鈕載入資料</div>
    </div>
  </div>

  <script>
    // API 端點 - 確保與後端 Controller 路徑一致
    window.apiemployee = 'http://localhost:8080/employees';
    window.apimember = 'http://localhost:8080/members';
    window.apiorders = 'http://localhost:8080/orders';
    window.apiproduct2 = 'http://localhost:8080/products';
    window.apilength = 'http://localhost:8080/length';
    window.apiweight = 'http://localhost:8080/weight';

    console.log('API endpoints loaded:', {
      employee: apiemployee,
      member: apimember,
      orders: apiorders,
      product: apiproduct2,
      length: apilength,
      weight: apiweight
    });

    window.container1 = document.getElementById('tableContainer');
    
    // 用來儲存目前的資料和表格名稱
    let currentData = [];
    let currentTableName = '';

    window.loadTable = async function(url, todiv, tableName) {
      try {
        todiv.textContent = "載入中...";
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP 錯誤: ${resp.status}`);
        const data = await resp.json();
        if (!Array.isArray(data) || data.length === 0) {
          todiv.textContent = '沒有資料';
          return;
        }

        // 儲存當前資料和表格名稱
        currentData = data;
        currentTableName = tableName;

        // 產生表格
        let table = '<table><thead><tr>';
        
        table += `<th>操作</th>`;
        const keys = Object.keys(data[0]);
        keys.forEach(k => {
          table += `<th>${k}</th>`;
        });
        table += '</tr></thead><tbody>';

        data.forEach((row, index) => {
          table += '<tr>';
          // 使用 data-index 來追蹤資料索引,避免 JSON 字串問題
          table += `<td><button class="delete-btn" onclick='window.deleteRow(${index})'>刪除</button></td>`;
          keys.forEach(k => {
            table += `<td>${row[k] ?? ''}</td>`;
          });
          table += '</tr>';
        });
        table += '</tbody></table>';
        todiv.innerHTML = table;
      } catch (err) {
        todiv.textContent = '載入失敗：' + err.message;
        console.error('載入錯誤:', err);
      }
    };

    window.deleteRow = function(index) {
      if (!confirm('確定要刪除這筆資料嗎?')) {
        return;
      }

      const row = currentData[index];
      const requestBody = {
        ...row,
        table: currentTableName,
        state: -1
      };

      fetch('http://localhost:8080/api/2/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody),
      })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP 錯誤: ${res.status}`);
        return res.json();
      })
      .then(data => {
        alert('刪除成功');
        // 重新載入表格
        const urlMap = {
          'employee': apiemployee,
          'member': apimember,
          'orders': apiorders,
          'product': apiproduct2,
          'length': apilength,
          'weight': apiweight
        };
        loadTable(urlMap[currentTableName], container1, currentTableName);
      })
      .catch(err => {
        alert('刪除失敗：' + err.message);
        console.error('刪除錯誤:', err);
      });
    };
  </script>
</body>
</html>